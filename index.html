<!DOCTYPE html>
<html>
<head>
    <title>Scientific Paper Managment Information System</title>

    <!-- Bootstrap for CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- For mobiles -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style type="text/css">

    body {
        background: #f8f8f8;
    }

    label {
        font-weight: normal;
    }

    #main-container {
        width: 60%;
        margin: auto;
    }

    .grid-row {
        display: table-row;
    }

    .grid-cell {
        display: table-cell;
        padding: 10px;
    }

    .date-input {
        width: 100px;
    }

    .heading {
        font-weight: bold;
        font-size: 1.3em;
    }

    #search-results {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        height: 100%;
    }

    #search-area {
        vertical-align: bottom;
    }

    #search-results li a {
        font-size: 1.2em;
    }

    .authors, .published-date {
        font-size: 0.9em;
    }

    .published-date {
        float: right;
    }

    .abstract-excerpt {
        color: gray;
    }

    </style>

</head>
<body>


<div id="main-container">

    <div class="grid-row">

        <!-- Title/logo -->
        <div class="grid-cell">
            <h1>Scientific Papers</h1>
        </div>

        <!-- Search box and search button -->
        <form class="grid-cell form-inline" id="search-area"
              onsubmit="search(this.query.value); return false">

            <input type="text" placeholder="Enter keywords..." class="form-control"
                   name="query" />
            <button class="btn btn-default">Search</button>
        </form>
    </div>

    <div class="grid-row">

        <!-- Sorting and filtering options -->
        <div class="grid-cell">

            <p class="heading">Sort by</p>

            <p>
                <select class="form-control">
                    <option>Relevance</option>
                    <option>Date ascending</option>
                    <option>Date descending</option>
                    <option>Reference count</option>
                </select>
            </p>

            <p class="heading">Filters</p>

            <p class="filter">
                <label>
                    <input type="checkbox" onchange="toggleFilter(this)">
                    Date between
                </label>
                <br />
                <span class="filter-controls">
                    <input type="text" class="date-input form-control" /> and
                    <input type="text" class="date-input form-control" />
                </span>
            </p>

            <p class="filter">
                <label>
                    <input type="checkbox" onchange="toggleFilter(this)">
                    Author:
                </label>
                <span class="filter-controls">
                    <input type="text" class="form-control" />
                </span>
            </p>
        </div>

        <div class="grid-cell">
            <!-- Search results -->
            <div id="search-results">
                <span id="message">Please enter a search query</span>
                <p>
                    <b>Related keywords:</b>
                    <span id="related-keywords"></span>
                </p>
                <p>
                   Showing <b id="no-of-results"></b> results for <b id="search-query"></b>
                </p>
                <ol id="results-list"></ol>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script type="text/javascript">

const API_KEY = "ba079b238ccdab296232e4ce8b9f5b6e";
const API_URL = "https://api.elsevier.com/content/search/scidir";

var API_FIELDS = {
    "title": "dc:title",
    "abstract": "dc:description",
    "authors": "authors",
    "published_date": "prism:coverDate",
    "url": "prism:url",
    "total_results": "opensearch:totalResults"
};

/*
 * Send an AJAX request to search ScienceDirect with the search query provided
 * and use the filters selected on the page. Call rankResults() when the request
 * completes
 */
function search(query) {
    $("#search-results").children().hide();
    $("#message").text("Loading...").show();;

    $("#search-area input").val(query);
    $("#search-area input").blur();

    $.ajax(API_URL, {
        "data": {
            "apiKey": API_KEY,
            "httpAccept": "application/json",
            "field": Object.values(API_FIELDS).join(","),
            "count": 50,
            "query": query
        },

        "error": function() {
            $("#message").text("Unexpected error querying ScienceDirect :(");
        },

        "success": function(data, textStatus) {
            rankResults(data);
        }
    });
}

/*
 * Format the search results from ScienceDirect and send to our server to be
 * ranked, and call showSearchResults() when it is complete
 */
function rankResults(results) {
    var formatted_results = {
        "query": results["search-results"]["opensearch:Query"]["@searchTerms"],
        "papers": []
    };

    if (results["search-results"][API_FIELDS.total_results] > 0) {
        var papers = results["search-results"]["entry"];

        for (var i=0; i<papers.length; i++) {

            // The link in the search results is an API link - replace the start
            // of it to get the actual link to the paper
            var link = papers[i][API_FIELDS.url];
            link = link.replace("https://api.elsevier.com/content/",
                                "https://www.sciencedirect.com/science/");

            // Put the author list into a single array
            var authors = [];

            // Check that the authors list is present
            if (API_FIELDS.authors in papers[i] &&
                "author" in papers[i][API_FIELDS.authors]) {

                var authors_list = papers[i].authors.author;

                for (var j=0; j<authors_list.length; j++) {
                    authors.push(authors_list[j]["given-name"] + " " +
                                 authors_list[j]["surname"]);
                }
            }
            else {
                authors = ["N/A"];
            }

            formatted_results.papers.push({
                "title": papers[i][API_FIELDS.title],
                "link": link,
                "authors": authors,
                "published_date": papers[i][API_FIELDS.published_date][0]["$"],
                "abstract": papers[i][API_FIELDS.abstract],
		"score": 0
            });

	    //increase score for age

	    var year = formatted_results.papers[i].published_date.slice(0,4);
	    var month = formatted_results.papers[i].published_date.slice(5,7);

	    var date = new Date();
;
	    var age_yr = date.getFullYear() - year;
	    var age_mth = date.getMonth() + 1 - month;

            var increase = 50 - (age_yr*12 + age_mth);
	    
	    if(increase < 0){
		increase = 0;
	    }

	    formatted_results.papers[i].score += increase;
        }

	//sorting results by score
	formatted_results.papers.sort(function (a,b){
		var sortStatus = 0;
		if(a.score>b.score){
		    sortStatus = -1;
		}else if(a.score<b.score){
		    sortStatus = 1;
		}
		return sortStatus;
	});

    }

    // TODO: Send formatted_results to our server via AJAX to do the ranking and
    // get related keywords, and call showSearchResults() when finished

    formatted_results.related_keywords = ["maths", "computer science", "physics"];
    showSearchResults(formatted_results);
}

/*
 * Show the actual search results on the page
 */
function showSearchResults(results) {
    $("#no-of-results").text(results.papers.length);
    $("#search-query").text(results.query);
    $("#results-list").text("");
    $("#related-keywords").text("");

    $("#search-results").children().show();
    $("#message").hide();

    // Show the related keywords
    for (let i=0; i<results.related_keywords.length; i++) {
        var $link = $("<a>", {"href": "#", "text": results.related_keywords[i]})
        $link.on("click",
            function() {
                search(results.related_keywords[i]);
            }
        );
        $("#related-keywords").append($link);

        if (i + 1 < results.related_keywords.length) {
            $("#related-keywords").append(", ");
        }
    }

    // Show the papers
    for (var i=0; i<results.papers.length; i++) {
        var $link = $("<a>", {
            "href": results.papers[i].link,
            "text": results.papers[i].title
        });

        var $authors = $("<span>", {
            "text": results.papers[i].authors.join(", "),
            "class": "authors"
        });

        var $date = $("<span>", {
            "text": "Published " + results.papers[i].published_date,
            "class": "published-date"
        });

        var abstract = results.papers[i].abstract || "No abstract available";

        // Some abstracts seem to start with the word 'Abstract' which is
        // not necessary to show
        if (abstract.substr(0, 8) == "Abstract") {
            abstract = abstract.substr(8);
        }

        // Trim the abstract if it is too long
        if (abstract.length > 500) {
            abstract = abstract.substr(0, 500) + "...";
        }

        var $p = $("<p>", {
            "text": abstract,
            "class": "abstract-excerpt"
        });

        var $li = $("<li>");
        $li.append($link, "<br />", $authors, $date, $p);
        $("#results-list").append($li);
    }
}

/*
 * Enable/disable the controls for a filter when the checkbox is
 * checked/unchecked
 */
function toggleFilter(checkbox) {

    var $el = $(checkbox);
    while (!($el.hasClass("filter"))) {
        $el = $el.parent();
    }

    var $inputs = $el.find(".filter-controls input");

    $inputs.each(function (index, input) {
        input.disabled = !checkbox.checked;
    });
}

// Enable or disable all the filter controls so that they match the state of
// the checkboxes
var checkboxes = document.querySelectorAll(".filter input[type=checkbox]");
for (var i=0; i<checkboxes.length; i++) {
    checkboxes[i].onchange();
}

$(document).ready(function() {
    // Hide the search results area
    $("#search-results").children().hide();
    $("#message").show();
});

</script>

</body>
</html>