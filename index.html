<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">

    <!-- Making the design of the website usign Bootstrap and an external CSS -->
    <link rel="stylesheet" type="text/css" href="index.css">
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"  integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- For mobiles -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Adding the Logo to the website-->
    <div class="Title">
    <!--<img src="../Yr2_group_project/Spapers_title.jpg"/>-->
    <img src="Spapers_title.jpg"/>
    </div>
</head>
<body>


<div class="Searching">
        <!-- Search box and search button -->
        <form class="grid-cell form-inline" id="search-area"
            onsubmit="search(this.query.value); return false">
            <input type="text" placeholder="Enter keywords..." class="form-control" maxlength="380" size="150" name="query" />
            <button class="btn btn-default">Search</button>
        </form>
</div>

<div id="SF-container">
        <!-- Sorting and filtering options -->
        <div class="Sorting_Filtering">
            <p class="heading">Sort by</p>
            <p>
                <select class="form-control" id="sort-dropdown">
                    <option value="relevance">Relevance</option>
                    <option value="date_asc">Date ascending</option>
                    <option value="date_desc">Date descending</option>
                    <option value="ref_count">Reference count</option>
                </select>
            </p>

            <p class="heading">Filters</p>
            <p class="filter" id="date-filter">
                <label>
                    <input type="checkbox" onchange="toggleFilter(this)">
                    Date between
                </label>
                <br />
                <span class="filter-controls">
                    <input type="text" class="date-input form-control"
                           placeholder="dd/mm/yyyy" />
                    and
                    <input type="text" class="date-input form-control"
                           placeholder="dd/mm/yyyy" />
                </span>
                <span class="help-block"></span>
            </p>
            <p class="filter">
                <label>
                    <input type="checkbox" onchange="toggleFilter(this)">
                    Author:
                </label>
                <span class="filter-controls">
                    <input type="text" class="form-control" maxlength="50"/>
                </span>
            </p>
        </div>
</div>

<div id="Result-container">
        <div class="grid-cell">
            <!-- Search results -->
            <div id="search-results">
                <span id="message">Please enter a search query</span>
                <p>
                    <b>Related keywords:</b>
                    <span id="related-keywords"></span>
                </p>
                <p>
                   Showing <b id="no-of-results"></b> results for <b id="search-query"></b>
                </p>
                <ol id="results-list"></ol>
            </div>
        </div>
</div>

<script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script type="text/javascript">

const API_KEY = "ba079b238ccdab296232e4ce8b9f5b6e";
const API_URL = "https://api.elsevier.com/content/search/scidir";

var API_FIELDS = {
    "title": "dc:title",
    "abstract": "dc:description",
    "authors": "authors",
    "published_date": "prism:coverDate",
    "url": "prism:url",
    "total_results": "opensearch:totalResults"
};

var ranked = { "papers" : [] };

// The fields that can be used in the API query to specify sort order
var SORT_FIELDS = {
    "relevance": "+relevancy",
    "date_asc": "+coverDate",
    "date_desc": "-coverDate"
}

// Regular expression to match dates in the format DD/MM/YYYY or DD-MM-YYYY
var date_regex = new RegExp(/^(\d\d)[/-](\d\d)[/-](\d\d\d\d)$/);

/*
 * Return a Date object from a string
 */
function parseDate(date_text) {
    var res = date_regex.exec(date_text);

    // Return null if the date string did not match the regex
    if (!res) {
        return null;
    }

    var day = parseInt(res[1]);
    var month = parseInt(res[2]);
    var year = parseInt(res[3]);

    // Return null is any of day, month or year are out of range
    if (day <= 0 || day > 31 || month <=0 || month > 12 || year <= 0) {
        return null;
    }

    var d = new Date(year, month, day);
    return d;
}

/*
 * Return the search query to send to the API. The format is described at this
 * page: http://api.elsevier.com/documentation/search/SCIDIRSearchTips.htm
 */
function buildQuery(search_terms) {
    return "key(" + search_terms + ") AND abs(" + search_terms + ") AND title(" +
           search_terms + ")";
}

/*
 * Send an AJAX request to search ScienceDirect with the search query provided
 * and use the filters selected on the page. Call rankResults() when the request
 * completes
 */
function search(query) {
    ranked = { "papers" : [] };

    if (!query) {
        return false;
    }

    var query_data = {
        "apiKey": API_KEY,
        "httpAccept": "application/json",
        "field": Object.values(API_FIELDS).join(","),
        "count": 50,
        "query": buildQuery(query)
    };

    // Store the original search term and the filtering applied so that we can
    // pass it to rankResults()
    var filtering = {
        "search_term": query
    };

    filtering["sort"] = $("#sort-dropdown").val();

    if (filtering["sort"] in SORT_FIELDS) {
        query_data["sort"] = SORT_FIELDS[filtering["sort"]];
    }

    // Remove error messages from date inputs if there was an error previously
    $("#date-filter .help-block").text("");
    $("#date-filter .filter-controls").removeClass("has-error");

    // If date filtering is selected...
    if ($("#date-filter input[type=checkbox]").is(":checked")) {
        var $date_boxes = $("#date-filter .date-input");

        var start_date = parseDate($date_boxes[0].value);
        var end_date = parseDate($date_boxes[1].value);

        if (!start_date || !end_date) {
            $date_boxes.parent().addClass("has-error");
            $("#date-filter .help-block").text("Invalid start/end date");
            return false;
            }

        else if (start_date >= end_date) {
            $("#date-filter .help-block").text("Start date must be before end date");
            return false;
        }

        else {
            // Add date range to data to be sent to API. Unfortunately the
            // lowest granularity for date filtering is years
            query_data["date"] = start_date.getFullYear() + "-" + end_date.getFullYear();

            filtering["start_date"] = start_date;
            filtering["end_date"] = end_date;
        }
    }

    $("#search-results").children().hide();
    $("#message").text("Loading...").show();;

    $("#search-area input").val(query);
    $("#search-area input").blur();

    $.ajax(API_URL, {
        "data": query_data,

        "error": function() {
            $("#message").text("Unexpected error querying ScienceDirect :(");
        },

        "success": function(data, textStatus) {
            rankResults(data, filtering);
        }
    });
}

/*
 * Format the search results from ScienceDirect and send to our server to be
 * ranked, and call showSearchResults() when it is complete
 */
function rankResults(results, filtering) {

    var formatted_results = {
        "query": filtering["search_term"],
        "papers": []
    };

    if (results["search-results"][API_FIELDS.total_results] > 0) {
        var papers = results["search-results"]["entry"];

        var start_date = filtering.start_date || null;
        var end_date = filtering.end_date || null;

        for (var i=0; i<papers.length; i++) {

            // The link in the search results is an API link - replace the start
            // of it to get the actual link to the paper
            var link = papers[i][API_FIELDS.url];
            link = link.replace("https://api.elsevier.com/content/",
                                "https://www.sciencedirect.com/science/");

            // Put the author list into a single array
            var authors = [];

            // Check that the authors list is present
            if (API_FIELDS.authors in papers[i] && papers[i][API_FIELDS.authors] &&
                "author" in papers[i][API_FIELDS.authors]) {

                var authors_list = papers[i].authors.author;

                for (var j=0; j<authors_list.length; j++) {
                    authors.push(authors_list[j]["given-name"] + " " +
                                 authors_list[j]["surname"]);
                }
            }
            else {
                authors = ["N/A"];
            }

            var p = {
                "title": papers[i][API_FIELDS.title],
                "link": link,
                "authors": authors,
                "published_date": papers[i][API_FIELDS.published_date][0]["$"],
                "abstract": papers[i][API_FIELDS.abstract],
            };

            // Convert published date from YYYY-MM-DD to DD-MM-YYYY format
            var d = p.published_date;
            p.published_date = d.substr(8, 2) + "-" + d.substr(5,2) + "-" + d.substr(0, 4);

            // If start date and end date filtering is applied then check the
            // date is in the correct range (since API only filters by year)
            if (start_date !== null && end_date !== null) {
                var pub_date = parseDate(p.published_date);

                // Skip if out of range
                if (pub_date < start_date || pub_date > end_date) {
                    continue;
                }
            }

            formatted_results.papers.push(p);
        }

	    rank(formatted_results);

    }

    // TODO: Send formatted_results to our server via AJAX to do the ranking and
    // get related keywords, and call showSearchResults() when finished
}


function rank(results){

	var startSize = ranked.papers.length;

	for (var i=0; i<results.papers.length; i++){
		ranked.papers.push({
		"title": results.papers[i]["title"],
                "link": results.papers[i]["link"],
                "authors": results.papers[i]["authors"],
                "published_date": results.papers[i]["published_date"],
                "abstract": results.papers[i]["abstract"],
		"score": 0
	});
	}

	//increase score for age

	for (var i=startSize; i<ranked.papers.length; i++){

	    var year = ranked.papers[i].published_date.slice(0,4);
	    var month = ranked.papers[i].published_date.slice(5,7);

	    var date = new Date();

	    var age_yr = date.getFullYear() - year;
	    var age_mth = date.getMonth() + 1 - month;

        var increase = 50 - (age_yr*12 + age_mth);

	    if(increase < 0){
	        increase = 0;
	    }

	    ranked.papers[i].score += increase;
	}

	//sorting results by score
	ranked.papers.sort(function (a,b){
		var sortStatus = 0;
		if(a.score>b.score){
		    sortStatus = -1;
		}else if(a.score<b.score){
		    sortStatus = 1;
		}
		return sortStatus;
	});

	var formatted_results = {
        "query": results["query"],
        "papers": ranked.papers
	};

	show(formatted_results);
}

function show(formatted_results){
	formatted_results.related_keywords = ["maths", "computer science", "physics"];
    showSearchResults(formatted_results);
}

/*
 * Show the actual search results on the page
 */
function showSearchResults(results) {
    $("#no-of-results").text(results.papers.length);
    $("#search-query").text(results.query);
    $("#results-list").text("");
    $("#related-keywords").text("");

    $("#search-results").children().show();
    $("#message").hide();

    // Show the related keywords
    for (let i=0; i<results.related_keywords.length; i++) {
        var $link = $("<a>", {"href": "#", "text": results.related_keywords[i]})
        $link.on("click",
            function() {
                search(results.related_keywords[i]);
            }
        );
        $("#related-keywords").append($link);

        if (i + 1 < results.related_keywords.length) {
            $("#related-keywords").append(", ");
        }
    }

    // Show the papers
    for (var i=0; i<results.papers.length; i++) {
        var $link = $("<a>", {
            "href": results.papers[i].link,
            "text": results.papers[i].title
        });

        var $authors = $("<span>", {
            "text": results.papers[i].authors.join(", "),
            "class": "authors"
        });

        var $date = $("<span>", {
            "text": "Published " + results.papers[i].published_date,
            "class": "published-date"
        });

        var abstract = results.papers[i].abstract || "No abstract available";

        // Some abstracts seem to start with the word 'Abstract' which is
        // not necessary to show
        if (abstract.substr(0, 8) == "Abstract") {
            abstract = abstract.substr(8);
        }

        // Trim the abstract if it is too long
        if (abstract.length > 500) {
            abstract = abstract.substr(0, 500) + "...";
        }

        var $p = $("<p>", {
            "text": abstract,
            "class": "abstract-excerpt"
        });

        var $li = $("<li>");
        $li.append($link, "<br />", $authors, $date, $p);
        $("#results-list").append($li);
    }
}

/*
 * Enable/disable the controls for a filter when the checkbox is
 * checked/unchecked
 */
function toggleFilter(checkbox) {

    var $el = $(checkbox);
    while (!($el.hasClass("filter"))) {
        $el = $el.parent();
    }

    var $inputs = $el.find(".filter-controls input");

    $inputs.each(function (index, input) {
        input.disabled = !checkbox.checked;
    });
}

// Enable or disable all the filter controls so that they match the state of
// the checkboxes
var checkboxes = document.querySelectorAll(".filter input[type=checkbox]");
for (var i=0; i<checkboxes.length; i++) {
    checkboxes[i].onchange();
}

$(document).ready(function() {
    // Hide the search results area
    $("#search-results").children().hide();
    $("#message").show();
});

</script>

</body>
</html>
