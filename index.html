<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">

    <!-- Making the design of the website usign Bootstrap and an external CSS -->
    <link rel="stylesheet" type="text/css" href="index.css">
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"  integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- For mobiles -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Adding the Logo to the website-->
    <div class="Title">
    <!--<img src="../Yr2_group_project/Spapers_title.jpg"/>-->
    <img src="Spapers_title.jpg"/>
    </div>
</head>
<body>


<div class="Searching">
        <!-- Search box and search button -->
        <form class="grid-cell form-inline" id="search-area"
            onsubmit="search(this.query.value); return false">
            <input type="text" placeholder="Enter keywords..." class="form-control" maxlength="380" size="150" name="query" />
            <button class="btn btn-default">Search</button>

            <br />

            <label>
                <input type="checkbox" id="advanced-search-checkbox"
                       onchange="toggleAdvancedSearch()" />
               Advanced search
           </label>

            <p id="advanced-search-help" class="help-text" style="display: none">
                You can use the search language described
                <a href="http://api.elsevier.com/documentation/search/SCIDIRSearchTips.htm">here</a>
            </p>

            <p>
                <label>
                    Find
                    <select class="form-control" id="Papers-dropdown">
                        <option value=50>50</option>
                        <option value=100>100</option>
                        <option value=150>150</option>
                        <option value=200>200</option>
                    </select>
                    papers
                </label>
                and
                <label>
                    show
                    <select class="form-control" id="perPage">
                        <option value=5>5</option>
                        <option value=10>10</option>
                        <option value=15>15</option>
                        <option value=20>20</option>
                    </select>
                    papers per page
                </label>
            </p>
        </form>
</div>

<div id="SF-container">
        <!-- Sorting and filtering options -->
        <div class="Sorting_Filtering">
            <p class="heading">Sort by</p>
            <p>
                <select class="form-control" id="sort-dropdown">
                    <option value="relevance">Relevance</option>
                    <option value="date_asc">Date ascending</option>
                    <option value="date_desc">Date descending</option>
                </select>
            </p>

            <p class="heading">Filters</p>
            <p class="filter" id="date-filter">
                <label>
                    <input type="checkbox" onchange="toggleFilter(this)">
                    Date between
                </label>
                <br />
                <span class="filter-controls">
                    <input type="text" class="date-input form-control"
                           placeholder="dd/mm/yyyy" />
                    and
                    <input type="text" class="date-input form-control"
                           placeholder="dd/mm/yyyy" />
                </span>
                <span class="help-block"></span>
            </p>
            <p class="filter">
                <label>
                    <input type="checkbox" onchange="toggleFilter(this)">
                    Author:
                </label>
                <span class="filter-controls">
                    <input type="text" class="form-control" maxlength="50"/>
                </span>
            </p>
        </div>
</div>

<div id="Result-container">
        <div class="grid-cell">
            <!-- Search results -->
            <div id="search-results">
                <span id="message">Please enter a search query</span>
                <p>
                    <b>Related keywords:</b>
                    <span id="related-keywords"></span>
		    <p align="right"><span onclick = "next(1)">next</span> <span onclick = "next(0)">prev</span></p>
                </p>
                <p>
                   Showing <b id="no-of-results"></b> results for <b id="search-query"></b>
                </p>
                <ol start="1" id="results-list"></ol>
            </div>
        </div>
</div>

<script type="text/javascript" src="stop_words.js"></script>
<script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script type="text/javascript">

const API_KEY = "ba079b238ccdab296232e4ce8b9f5b6e";
const API_URL = "https://api.elsevier.com/content/search/scidir";

var API_FIELDS = {
    "title": "dc:title",
    "abstract": "dc:description",
    "authors": "authors",
    "published_date": "prism:coverDate",
    "url": "prism:url",
    "total_results": "opensearch:totalResults",
    "keywords": "authkeywords"
};

// The maximum number of characters to show in the abstract before truncating
var MAX_ABSTRACT_LENGTH = 500;

// Regular expression to match dates in the format DD/MM/YYYY or DD-MM-YYYY
var date_regex = new RegExp(/^(\d\d)[/-](\d\d)[/-](\d\d\d\d)$/);

// Regex to remove field names that can be used in the advanced search so we
// can extract the actual search terms when highlighting keywords
var advanced_search_fields_regexp = new RegExp("tak|abs|aut|aus|aff|pdt|key|" +
                                               "ref|ttl|src|sub|vis|pag", "gi")

/*
 * Return a Date object from a string
 */

//papers per page and current begining of page for moving between papers.
var papersPerPage = 0;
var currentIndex = 0;

//the results put here so it is in scope for recalling show papers from the next function.
var saved;

function parseDate(date_text) {
    var res = date_regex.exec(date_text);

    // Return null if the date string did not match the regex
    if (!res) {
        return null;
    }

    var day = parseInt(res[1]);
    var month = parseInt(res[2]);
    var year = parseInt(res[3]);

    // Return null is any of day, month or year are out of range
    if (day <= 0 || day > 31 || month <=0 || month > 12 || year <= 0) {
        return null;
    }

    var d = new Date(year, month, day);
    return d;
}

/*
 * Toggle the advanced search help text
 *
 */
function toggleAdvancedSearch() {
    $("#advanced-search-help").toggle();
}

/*
 * Return the search query to send to the API. The format is described at this
 * page: http://api.elsevier.com/documentation/search/SCIDIRSearchTips.htm
 */
function buildQuery(search_terms) {
    return "key(" + search_terms + ") AND abs(" + search_terms + ") AND title(" +
           search_terms + ")";
}

/*
 * Send an AJAX request to search ScienceDirect with the search query provided
 * and use the filters selected on the page. Call rankResults() when the request
 * completes
 */
function search(query, iterative_search) {
    if (!query) {
        return false;
    }

    var advanced_search = $("#advanced-search-checkbox").is(":checked");
    var min_papers = $("#Papers-dropdown").val();

    var query_data = {
        "apiKey": API_KEY,
        "httpAccept": "application/json",
        "field": Object.values(API_FIELDS).join(","),
        "count": min_papers,
        "sort": "+relevancy",
        "query": (advanced_search && !iterative_search ? query : buildQuery(query))
    };

    // Store the original search term and the filtering applied so that we can
    // pass it to rankResults()
    var filtering = {
        "search_term": query,
        "sort": $("#sort-dropdown").val(),
        "min_papers": min_papers
    };

    // Remove error messages from date inputs if there was an error previously
    $("#date-filter .help-block").text("");
    $("#date-filter .filter-controls").removeClass("has-error");

    // If date filtering is selected...
    if ($("#date-filter input[type=checkbox]").is(":checked")) {
        var $date_boxes = $("#date-filter .date-input");

        var start_date = parseDate($date_boxes[0].value);
        var end_date = parseDate($date_boxes[1].value);

        if (!start_date || !end_date) {
            $date_boxes.parent().addClass("has-error");
            $("#date-filter .help-block").text("Invalid start/end date");
            return false;
            }

        else if (start_date >= end_date) {
            $("#date-filter .help-block").text("Start date must be before end date");
            return false;
        }

        else {
            // Add date range to data to be sent to API. Unfortunately the
            // lowest granularity for date filtering is years
            query_data["date"] = start_date.getFullYear() + "-" + end_date.getFullYear();

            filtering["start_date"] = start_date;
            filtering["end_date"] = end_date;
        }
    }

    if (iterative_search) {
        $("#message").text("Searching for '" + query + "'...").show();;
    }
    else {
        $("#search-results").children().hide();
        $("#message").text("Loading...").show();;

        $("#search-area input").val(query);
        $("#search-area input").blur();
    }

    $.ajax(API_URL, {
        "data": query_data,

        "error": function() {
            $("#message").text("Unexpected error querying ScienceDirect :(");
        },

        "success": function(data, textStatus) {
            rankResults(data, filtering);
        }
    });
}

/*
 * Format the search results from ScienceDirect and send to our server to be
 * ranked, and call showSearchResults() when it is complete
 */
function rankResults(results, filtering) {

    var formatted_results = {
        "query": filtering["search_term"],
        "papers": []
    };

    if (results["search-results"][API_FIELDS.total_results] > 0) {
        var papers = results["search-results"]["entry"];

        var start_date = filtering.start_date || null;
        var end_date = filtering.end_date || null;

        for (var i=0; i<papers.length; i++) {

            // The link in the search results is an API link - replace the start
            // of it to get the actual link to the paper
            var link = papers[i][API_FIELDS.url];
            link = link.replace("https://api.elsevier.com/content/",
                                "https://www.sciencedirect.com/science/");

            // Put the author list into a single array
            var authors = [];

            // Check that the authors list is present
            if (API_FIELDS.authors in papers[i] && papers[i][API_FIELDS.authors] &&
                "author" in papers[i][API_FIELDS.authors]) {

                var authors_list = papers[i].authors.author;

                for (var j=0; j<authors_list.length; j++) {
                    authors.push(authors_list[j]["given-name"] + " " +
                                 authors_list[j]["surname"]);
                }
            }
            else {
                authors = ["N/A"];
            }

            var keywords = [];
            if (papers[i][API_FIELDS.keywords]) {
                keywords = papers[i][API_FIELDS.keywords].split(" | ");
            }
            else {
                keywords = [];
            }

            var p = {
                "title": papers[i][API_FIELDS.title],
                "link": link,
                "authors": authors,
                "published_date": papers[i][API_FIELDS.published_date][0]["$"],
                "abstract": papers[i][API_FIELDS.abstract],
                "keywords": keywords
            };

            // Convert published date from YYYY-MM-DD to DD-MM-YYYY format
            var d = p.published_date;
            p.published_date = d.substr(8, 2) + "-" + d.substr(5,2) + "-" + d.substr(0, 4);

            // If start date and end date filtering is applied then check the
            // date is in the correct range (since API only filters by year)
            if (start_date !== null && end_date !== null) {
                var pub_date = parseDate(p.published_date);

                // Skip if out of range
                if (pub_date < start_date || pub_date > end_date) {
                    continue;
                }
            }

            formatted_results.papers.push(p);
        }
    }

    // Send formatted_results to our server via AJAX to do the ranking and
    // get related keywords, and call showSearchResults() when finished
    $.ajax("rank.php", {
        "method": "POST",
        "data": {
            "r":  JSON.stringify(formatted_results),
            "sort": filtering["sort"],
            "min_papers": filtering["min_papers"]
        },

        "error": function() {
            $("#message").text("Unexpected error :(");
        },

        "success": function(data, textStatus) {
            var temp = JSON.parse(data);

            if ("iterative_search" in temp) {
                search(temp["iterative_search"], true);
            }
            else {
                for (var i=0; i<temp.debug.length; i++) {
                    console.log("DEBUG: " + temp.debug[i]);
                }
		        saved = temp;
                showSearchResults(temp);
            }
        }
    });
}

/*
 * Find the given keywords in the given string of text and wrap them in a span
 * tag so they can be highlighted. Return an object containing the new text and
 * the number of matches
 */
function highlightKeywords(text, keywords) {
    var regexp = new RegExp(keywords.join("|"), "gi");
    var matches = 0;

    var replacer = function(match) {
        matches++;
        return "<span class='highlight'>" + match + "</span>";
    }

    var new_text = text.replace(regexp, replacer);
    return {
        "text": new_text,
        "matches": matches
    };
}

/*
 * Show the whole abstract for a paper for when the abstract is over
 * MAX_ABSTRACT_LENGTH characters and is truncated. This is called when the
 * 'Show more' link is cliced
 */
function showMoreAbstract(link) {
    var $more_span = $(link).parent();
    var $abstract = $more_span.parent();

    $more_span.hide();
    $abstract.find(".hidden").removeClass("hidden");
}

/*
 * Show the actual search results on the page
 */
function showSearchResults(results) {
    $("#no-of-results").text(results.papers.length);
    $("#search-query").text(results.query);
    $("#results-list").text("");
    $("#related-keywords").text("");

    $("#search-results").children().show();
    $("#message").hide();

    // Show the related keywords
    for (let i=0; i<results.related_keywords.length; i++) {
        var $link = $("<a>", {"href": "#", "text": results.related_keywords[i]})
        $link.on("click",
            function() {
                search(results.related_keywords[i]);
            }
        );
        $("#related-keywords").append($link);

        if (i + 1 < results.related_keywords.length) {
            $("#related-keywords").append(", ");
        }
    }

    var advanced_search = $("#advanced-search-checkbox").is(":checked");
    if (advanced_search) {
        // 1. Remove AND, OR, NOT and brackets
        // 2. Remove field names (e.g. abs, ttl, ref)
        results.query = results.query.replace(/AND|OR|NOT|\(|\)/gi, "")
                                     .replace(advanced_search_fields_regexp, "");
    }

    // Remove excessive whitespace and split by space to get keywords
    var keywords = results.query.replace(/\s+/g, " ").split(" ");

    // Remove stop words from keywords since they do not need to be highlighted
    for (var i=0; i<keywords.length; i++) {
        if (STOP_WORDS.indexOf(keywords[i].toLowerCase()) != -1) {
            keywords.splice(i, 1);
            i--;
        }
    }

    papersPerPage = parseInt(document.getElementById("perPage").value);

    document.getElementById("results-list").setAttribute("start", currentIndex + 1);

    // Show the papers
    for (var i=currentIndex; i<results.papers.length && i<currentIndex + papersPerPage; i++) {

        var keywords_matches = 0;

        var hi_title = highlightKeywords(results.papers[i].title, keywords);
        keywords_matches += hi_title.matches;

        var $link = $("<a>", {
            "href": results.papers[i].link,
            "html": hi_title.text,
            "class": "paper-title"
        });

        var $authors = $("<span>", {
            "text": results.papers[i].authors.join(", "),
            "class": "authors"
        });

        var $date = $("<span>", {
            "text": "Published " + results.papers[i].published_date,
            "class": "published-date"
        });

        var abstract = results.papers[i].abstract || "No abstract available";

        // Some abstracts seem to start with the word 'Abstract' which is
        // not necessary to show
        if (abstract.substr(0, 8) == "Abstract") {
            abstract = abstract.substr(8);
        }

        var abstract_html = "";

        // Trim the abstract if it is too long
        if (abstract.length > MAX_ABSTRACT_LENGTH) {
            var more_link = "<a onclick='showMoreAbstract(this)' " +
                                "class='show-more-link'>Show more</a>";
            var show_more_span = "<span>..." + more_link + "</span>";

            // Split the abstract up into shown part and hidden part
            var shown_excerpt = abstract.substr(0, MAX_ABSTRACT_LENGTH);
            var hidden_excerpt = abstract.substr(MAX_ABSTRACT_LENGTH);

            // Highlight shown and hidden parts and increase match counter
            var hi_shown = highlightKeywords(shown_excerpt, keywords);
            var hi_hidden = highlightKeywords(hidden_excerpt, keywords);
            keywords_matches += hi_shown.matches;
            keywords_matches += hi_hidden.matches;

            abstract_html = hi_shown.text + show_more_span + "<span class='hidden'>" +
                            hi_hidden.text + "</span>";
        }
        else {
            var hi_abs = highlightKeywords(abstract, keywords);
            keywords_matches += hi_abs.matches;

            abstract_html = hi_abs.text;
        }

        var $p = $("<p>", {
            "html": abstract_html,
            "class": "abstract-excerpt"
        });

        var $p2 = $("<p>", {
            "text": keywords_matches + " matches"
        })

        var $li = $("<li>");
        $li.append($link, "<br />", $authors, $date, $p, $p2);
        $("#results-list").append($li);
    }
}

function next(status){
    if(status == 0){
	currentIndex -= papersPerPage;
	if(currentIndex < 0){
	    currentIndex = 0;
	}
    }else{
	if(currentIndex + 2*papersPerPage <= saved.papers.length){
	     currentIndex += papersPerPage;
	}else{
	     currentIndex = saved.papers.length - papersPerPage;
	}
    }

    showSearchResults(saved);
}

/*
 * Enable/disable the controls for a filter when the checkbox is
 * checked/unchecked
 */
function toggleFilter(checkbox) {

    var $el = $(checkbox);
    while (!($el.hasClass("filter"))) {
        $el = $el.parent();
    }

    var $inputs = $el.find(".filter-controls input");

    $inputs.each(function (index, input) {
        input.disabled = !checkbox.checked;
    });
}

// Enable or disable all the filter controls so that they match the state of
// the checkboxes
var checkboxes = document.querySelectorAll(".filter input[type=checkbox]");
for (var i=0; i<checkboxes.length; i++) {
    checkboxes[i].onchange();
}

$(document).ready(function() {
    // Hide the search results area
    $("#search-results").children().hide();
    $("#message").show();
});

</script>

</body>
</html>
